name: Publish docs

# Run this workflow on push to 1.x (e.g. on merge of PR to 1.x)
on:
  push:
    branches:
      - 1.x

jobs:
  # Set the job key. The key is displayed as the job name
  # when a job name is not provided
  run-tests:
    # Name the Job
    name: Run tests against Ansible code base
    # Set the type of machine to run on
    runs-on: ubuntu-20.04

    steps:
      # Configures global Git variables for committing
      - name: Configure Git
        run: |
          git config --global user.email "sysadm@codeenigma.com"
          git config --global user.name "Code Enigma CI"

      # Uses the ce-dev stack to run Hugo to format and deploy the docs
      - name: Publish documentation
        run: |
          cd
          git clone https://github.com/codeenigma/wikis2pages.git
          cd wikis2pages
          /bin/bash init.sh https://${{ secrets.GITHUB_TOKEN }}@github.com/codeenigma/ce-provision.git 1.x
          /bin/sh set-current.sh ce-provision-1.x
          docker exec --user ce-dev --workdir /home/ce-dev/deploy/live.local wikis2pages-hugo hugo
          /bin/sh .github-actions-push.sh
          cd /home/runner/wikis2pages/public/ce-provision-1.x
          git remote add ci https://${{ secrets.DOCS_GITHUB_TOKEN }}@github.com/codeenigma/ce-provision-docs.git
          git push ci master
        shell: bash
