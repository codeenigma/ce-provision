---
# tasks file for opcache
#

# @todo We could look up PHP version and install the latest for that version
- name: Install latest cachetool
  ansible.builtin.get_url:
    url: https://gordalina.github.io/cachetool/downloads/cachetool.phar
    dest: /usr/local/bin/cachetool
    owner: root
    group: root
    mode: "0755"
  when: opcache.cachetool_version == 'latest'

- name: "Install cachetool version {{ opcache.cachetool_version }}"
  ansible.builtin.get_url:
    url: "https://gordalina.github.io/cachetool/downloads/cachetool-{{ opcache.cachetool_version }}.phar"
    dest: /usr/local/bin/cachetool
    owner: root
    group: root
    mode: "0755"
  when: opcache.cachetool_version != 'latest'

- name: Get php-fpm host
  ansible.builtin.shell:
    cmd: "netstat -anp | grep php-fpm | grep tcp | awk '{print $4}' | cut -d: -f1"
  register: _phpfpm_host

- name: Get php-fpm port
  ansible.builtin.shell:
    cmd: "netstat -anp | grep php-fpm | grep tcp | awk '{print $4}' | cut -d: -f2"
  register: _phpfpm_port

- name: Copy cachetool config
  ansible.builtin.template:
    src: cachetool.j2
    dest: /etc/cachetool.yml
    owner: root
    group: root
    mode: "0644"
