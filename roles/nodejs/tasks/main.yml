---
- name: Add repository key for NodeJS repository.
  ansible.builtin.apt_key:
    url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
    state: present

- name: Add repository for NodeJS.
  ansible.builtin.apt_repository: "repo='deb https://deb.nodesource.com/node_{{ nodejs.version }} {{ ansible_distribution_release }} main' state=present"

- name: Add source repository for NodeJS.
  ansible.builtin.apt_repository: "repo='deb-src https://deb.nodesource.com/node_{{ nodejs.version }} {{ ansible_distribution_release }} main' state=present"

- name: Add repository key for Yarn repository.
  ansible.builtin.apt_key: url=https://dl.yarnpkg.com/debian/pubkey.gpg state=present

- name: Add repository for Yarn.
  ansible.builtin.apt_repository:
    repo: "deb https://dl.yarnpkg.com/debian/ stable main"
    state: present

- name: Pin Node packages.
  ansible.builtin.template:
    src: nodesource.pref.j2
    dest: "/etc/apt/preferences.d/nodesource.pref"
    owner: root
    group: root
    mode: "0644"
    force: true

- name: Ensure NodeJS and Yarn are installed.
  ansible.builtin.apt:
    pkg: ["nodejs", "yarn"]
    state: present

- name: Install npm packages.
  community.general.npm:
    name: "{{ item.name }}"
    version: "{{ item.version | default(omit) }}"
  with_items: "{{ nodejs.npm_packages }}"
  when: nodejs.npm_packages | length > 0
