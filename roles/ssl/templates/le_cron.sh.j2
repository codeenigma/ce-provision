#!/bin/bash

# stop services
{% for service in _ssl_services %}
service {{ service }} stop
{% endfor %}

# build bash array of domains
SITES=()
{% for domain in _ssl_domains %}
SITES+=("{{ domain }}")
{% endfor %}

# turn array into certbot compatible sites string
SITESSTRING=""
for site in ${SITES[@]}; do
  SITESSTRING+=" -d $site"
done

{% if _ssl_web_server == 'none' %}
# run certbot
{{ ssl.certbot_renew_command }} --http-01-port {{ ssl.http_01_port }} --expand$SITESSTRING
{% else %}
# run certbot
{{ ssl.certbot_renew_command }} --http-01-port {{ ssl.http_01_port }} --{{ _ssl_web_server }} --expand$SITESSTRING
{% endif %}

# start services again
{% for service in _ssl_services %}
service {{ service }} start
{% endfor %}
