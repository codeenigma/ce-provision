---
- name: Define SSL base path.
  ansible.builtin.set_fact:
    _ssl_base_path: "/etc/ssl/provided"

- name: Create SSL directory.
  ansible.builtin.file:
    path: "{{ _ssl_base_path }}"
    state: directory

- name: Add key/cert pairs to know paths information.
  ansible.builtin.set_fact:
    ssl_facts: "{{ ssl_facts | combine({ domain: { 'domain': domain, 'certificate': _ssl_base_path + '/' + domain + '.cert', 'ca_certificate': _ssl_base_path + '/' + domain + '.CA.cert', 'key': _ssl_base_path + '/' + domain + '.key' } }) }}"
  with_items: "{{ ssl.domains }}"
  loop_control:
    loop_var: domain

- name: Copy keys and certificates if necessary.
  ansible.builtin.include_tasks: copy.yml
  with_items: "{{ ssl.domains }}"
  loop_control:
    loop_var: domain
