---
# Do not include the _exit role at the end of a play without including the _init role at the start.
- name: Generate/Update custom vars file.
  ansible.builtin.include_tasks: allowed_vars.yml
  when:
    - _init.ce_provision_extra_repository
    - _init.ce_provision_extra_repository_vars_file
    - _init.ce_provision_extra_repository_push

- name: Store current playbook md5.
  ansible.builtin.copy:
    content: "{{ current_play_dir_md5 }}"
    dest: "{{ _ce_provision_data_dir }}/{{ current_play_md5_file }}"
  delegate_to: localhost

# Tidy up any unneeded APT packages.
- name: Remove dependencies that are no longer required.
  ansible.builtin.apt:
    autoremove: true
  become: true

- name: Gather host details for motd.
  ansible.builtin.shell: >
    set -o pipefail && /usr/bin/hostnamectl | /usr/bin/awk '/hostname|Operating|Kernel|Hardware Model/'
  args:
    executable: /bin/bash
  register: _host_details

- name: Gather datetime details for motd.
  ansible.builtin.shell: >
    date
  register: _last_build

- name: Generate/Update custom vars file.
  ansible.builtin.template:
    src: motd.j2
    dest: "/etc/motd"
    mode: "0755"
    owner: root
    group: root

- name: Delete the lock file.
  ansible.builtin.file:
    path: "{{ _init.lock_file }}"
    state: absent
