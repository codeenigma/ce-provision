---
- name: Remove old PPA repository key for Ansible.
  ansible.builtin.apt_key:
    id: 93C4A3FD7BB9C367
    keyserver: keyserver.ubuntu.com
    state: absent

- name: Remove old repository for Ansible.
  ansible.builtin.apt_repository:
    repo: "deb http://ppa.launchpad.net/ansible/ansible/ubuntu trusty main"
    state: absent

# Linters need a newer version of PyYAML than the one that ships with Debian.
- name: Remove older PyYAML package.
  ansible.builtin.apt:
    pkg: ["python3-yaml"]
    state: absent

- name: Check pip is still installed.
  ansible.builtin.stat:
    path: /usr/bin/pip
  register: _path_to_pip

- name: Ensure Ansible is not installed by pip.
  ansible.builtin.command:
    cmd: pip uninstall ansible -y
  become: true
  when: _path_to_pip.stat.exists

- name: Set up pip3.
  ansible.builtin.include_role:
    name: python-pip

# Not using 'apt' - this needs to be one task or we break controller servers acting on themselves.
- name: Remove and re-install Ansible.
  ansible.builtin.shell:
    cmd: sudo apt-get -y remove ansible && sudo pip3 install ansible
  become: false

- name: Install linters.
  ansible.builtin.pip:
    name:
      - ansible-lint
      - yamllint
    executable: pip3

# This package gets removed with python3-yaml above but we need it for auto-scale.
- name: Install cloud-init.
  ansible.builtin.apt:
    name: cloud-init
