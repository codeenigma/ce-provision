---
  - name: Install dependencies to build Wazuh packages
    ansible.builtin.package:
      name:
        - make
        - gcc
        - automake
        - autoconf
        - libtool
        - tar
      state: present

  - name: Removing old files
    ansible.builtin.file:
      path: "/tmp/{{ wazuh_agent_sources_installation.branch }}.tar.gz"
      state: absent

  - name: Removing old folders
    ansible.builtin.file:
      path: "/tmp/wazuh-{{ wazuh_agent_sources_installation.branch }}"
      state: absent

  - name: Installing policycoreutils-python (RedHat families)
    ansible.builtin.package:
      name:
        - policycoreutils-python
    when:
      - ansible_os_family|lower == "redhat"

  - name: Installing policycoreutils-python-utils (Debian families)
    ansible.builtin.package:
      name:
        - libc6-dev
        - curl
        - policycoreutils
    when:
      - ansible_os_family|lower == "debian"

  - name: Download required packages from github.com/wazuh/wazuh
    ansible.builtin.get_url:
      url: "https://github.com/wazuh/wazuh/archive/{{ wazuh_agent_sources_installation.branch }}.tar.gz"
      dest: "/tmp/{{ wazuh_agent_sources_installation.branch }}.tar.gz"
    delegate_to: "{{ inventory_hostname }}"
    changed_when: false

  - name: Create folder to extract Wazuh branch
    ansible.builtin.file:
      path: "/tmp/wazuh-{{ wazuh_agent_sources_installation.branch }}"
      mode: 0755
      state: directory
    changed_when: false

  - name: Extract downloaded Wazuh branch from Github # Using shell instead of unarchive due to that module not working properlyh with --strip
    ansible.builtin.command: >-
      tar -xzvf /tmp/{{ wazuh_agent_sources_installation.branch }}.tar.gz
      --strip 1
      --directory /tmp/wazuh-{{ wazuh_agent_sources_installation.branch }}
    register: wazuh_untar
    changed_when: false
    args:
      warn: false

  - name: Clean remaining files from others builds
    ansible.builtin.command: "make -C src {{ item }}"
    args:
      chdir: "/tmp/wazuh-{{ wazuh_agent_sources_installation.branch }}/src/"
    with_items:
      - "clean"
      - "clean-deps"
    register: clean_result
    changed_when: clean_result.rc == 0
    failed_when: false

  - name: Render the "preloaded-vars.conf" file
    ansible.builtin.template:
      src: "templates/preloaded_vars_agent.conf.j2"
      dest: "/tmp/wazuh-{{ wazuh_agent_sources_installation.branch }}/etc/preloaded-vars.conf"
      owner: root
      group: root
      mode: 0644
    changed_when: false

  - name: Executing "install.sh" script to build and install the Wazuh Agent
    ansible.builtin.shell: ./install.sh > /tmp/build_agent_log.txt
    register: installation_result
    changed_when: installation_result == 0
    args:
      chdir: "/tmp/wazuh-{{ wazuh_agent_sources_installation.branch }}"

  - name: Cleanup downloaded files
    ansible.builtin.file:
      path: "/tmp/{{ wazuh_agent_sources_installation.branch }}.tar.gz"
      state: absent
    changed_when: false

  - name: Cleanup created folders
    ansible.builtin.file:
      path: "/tmp/wazuh-{{ wazuh_agent_sources_installation.branch }}"
      state: absent
    changed_when: false