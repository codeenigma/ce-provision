---
- name: Add repository key for Gitlab.
  ansible.builtin.apt_key:
    url: https://packages.gitlab.com/gitlab/gitlab-ce/gpgkey
    state: present

- name: Add repository for Gitlab.
  ansible.builtin.apt_repository:
    repo: "deb https://packages.gitlab.com/gitlab/gitlab-ce/debian/ {{ ansible_distribution_release }} main"
    state: present

- name: Add source repository for Gitlab.
  ansible.builtin.apt_repository:
    repo: "deb-src https://packages.gitlab.com/gitlab/gitlab-ce/debian/ {{ ansible_distribution_release }} main"
    state: present

- name: Ensure Gitlab is installed.
  ansible.builtin.apt:
    pkg: "gitlab-ce"
    state: present
    update_cache: true

- name: Generates SSL keys.
  ansible.builtin.include_role:
    name: ssl
  when: gitlab.ssl.enabled
  vars:
    ssl: "{{ gitlab.ssl | combine( { 'domain': gitlab.server_name } ) }}"

- name: Copy Gitlab configuration file.
  ansible.builtin.template:
    src: gitlab.rb.j2
    dest: /etc/gitlab/gitlab.rb

- name: Copy Gitlab configuration script.
  ansible.builtin.template:
    src: gitlab-config.rb.j2
    dest: /etc/gitlab/gitlab-config.rb

- name: Let Gitlab know it's on Docker.
  ansible.builtin.copy:
    content: "gitlab-docker"
    dest: "/opt/gitlab/embedded/service/gitlab-rails/INSTALLATION_TYPE"
    mode: "0666"
  when:
    - is_local is defined
    - is_local

- name: Copy startup script in place.
  ansible.builtin.template:
    src: docker-init.sh.j2
    dest: "/opt/gitlab-init.sh"
    owner: root
    group: root
    mode: "0555"
    force: true
  when:
    - is_local is defined
    - is_local

- name: Trigger overrides
  ansible.builtin.include_role:
    name: _overrides
  vars:
    _overrides: "{{ gitlab.overrides }}"
  when:
    - gitlab.overrides is defined
    - gitlab.overrides | length > 0

- name: Manually restart Gitlab/Docker.
  ansible.builtin.command: "/bin/sh /opt/gitlab-init.sh"
  when:
    - is_local is defined
    - is_local

- name: Stop Gitlab.
  ansible.builtin.command: /opt/gitlab/bin/gitlab-ctl stop

- name: Reconfigure Gitlab.
  ansible.builtin.command: /opt/gitlab/bin/gitlab-ctl reconfigure

- name: Restart Gitlab.
  ansible.builtin.command: /opt/gitlab/bin/gitlab-ctl start

- name: Run the GitLab configuration script for config that cannot be set in gitlab.rb.
  ansible.builtin.command: "gitlab-rails runner /etc/gitlab/gitlab-config.rb"
  when: gitlab.disable_signup
