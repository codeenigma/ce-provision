---
- name: Add repository key for Gitlab.
  ansible.builtin.apt_key:
    url: https://packages.gitlab.com/gitlab/gitlab-ce/gpgkey
    state: present

- name: Add repository for Gitlab.
  ansible.builtin.apt_repository:
    repo: "deb https://packages.gitlab.com/gitlab/gitlab-ce/debian/ buster main"
    state: present

- name: Add source repository for Gitlab.
  ansible.builtin.apt_repository:
    repo: "deb-src https://packages.gitlab.com/gitlab/gitlab-ce/debian/ buster main"
    state: present

- name: Ensure Gitlab is installed.
  ansible.builtin.apt:
    pkg: "gitlab-ce"
    state: present
    update_cache: true

- name: Generates SSL keys.
  ansible.builtin.include_role:
    name: ssl
  when: gitlab.ssl.enabled
  vars:
    ssl: "{{ gitlab.ssl | combine( { 'domain': gitlab.server_name } ) }}"

- name: Copy Gitlab configuration file.
  ansible.builtin.template:
    src: gitlab.rb.j2
    dest: /etc/gitlab/gitlab.rb

- name: Let Gitlab know it's on Docker.
  ansible.builtin.copy:
    content: "gitlab-docker"
    dest: "/opt/gitlab/embedded/service/gitlab-rails/INSTALLATION_TYPE"
    mode: "0666"
  when:
    - is_local is defined
    - is_local

- name: Copy startup script in place.
  ansible.builtin.template:
    src: docker-init.sh.j2
    dest: "/opt/gitlab-init.sh"
    owner: root
    group: root
    mode: "0555"
    force: true
  when:
    - is_local is defined
    - is_local

- name: Trigger overrides
  ansible.builtin.include_role:
    name: _overrides
  vars:
    _overrides: "{{ gitlab.overrides }}"
  when:
    - gitlab.overrides is defined
    - gitlab.overrides | length > 0

- name: Manually restart Gitlab/Docker.
  ansible.builtin.command: "/bin/sh /opt/gitlab-init.sh"
  when:
    - is_local is defined
    - is_local

- name: Stop Gitlab.
  ansible.builtin.command: /opt/gitlab/bin/gitlab-ctl stop

- name: Reconfigure Gitlab.
  ansible.builtin.command: /opt/gitlab/bin/gitlab-ctl reconfigure

- name: Restart Gitlab.
  ansible.builtin.command: /opt/gitlab/bin/gitlab-ctl start

  # @TODO Can these settings go into gitlab.rb?
  # Seems any ApplicationSetting can - see example: https://gitlab.com/gitlab-org/gitlab-foss/-/issues/17296
- name: Disable self-register feature
  ansible.builtin.command: "gitlab-rails runner 'ApplicationSetting.last.update(signup_enabled: false)'"
  when: gitlab.disable_signup

- name: Disable DSA keys
  ansible.builtin.command: "gitlab-rails runner 'ApplicationSetting.last.update(dsa_key_restriction: -1)'"

- name: Disable ECDSA
  ansible.builtin.command: "gitlab-rails runner 'ApplicationSetting.last.update(ecdsa_key_restriction: -1)'"

- name: Enforce at least 2048bits for RSA
  ansible.builtin.command: "gitlab-rails runner 'ApplicationSetting.last.update(rsa_key_restriction: 2048)'"

- name: Disable password auth over HTTP/S
  ansible.builtin.command: "gitlab-rails runner 'ApplicationSetting.last.update(password_authentication_enabled_for_git: false)'"

- name: Ensure user data and projects are private
  ansible.builtin.command: "gitlab-rails runner 'ApplicationSetting.last.update(restricted_visibility_levels: [10, 20])'"
  when: gitlab.private_projects

- name: Disable standard sign-in dialogue
  ansible.builtin.command: "gitlab-rails runner 'Gitlab::CurrentSettings.update!(password_authentication_enabled_for_web: false)'"
  when: gitlab.disable_signin
