---
- name: Install OpenVPN server.
  ansible.builtin.include_role:
    name: robertdebock.openvpn

- name: Install OpenVPN LDAP auth package.
  ansible.builtin.package:
    name: "openvpn-auth-ldap"
    state: present

- name: Ensure LDAP config directory exists.
  ansible.builtin.file:
    path: "{{ openvpn_configuration_directory }}/auth"
    state: directory
    mode: "0755"

- name: Place LDAP CA cert.
  ansible.builtin.copy:
    src: "{{ open_ldap.tls_cert_local }}"
    dest: "{{ open_ldap.tls_cert }}"
    owner: root
    group: root
    mode: "0644"
  when: open_ldap.tls_cert_local

- name: Place auth-ldap.conf file.
  ansible.builtin.template:
    src: auth-ldap.conf.j2
    dest: "{{ openvpn_configuration_directory }}/auth/auth-ldap.conf"
    owner: root
    group: root
    mode: "0644"

# Loop files from https://github.com/robertdebock/ansible-role-openvpn/blob/master/tasks/server.yml#L58
- name: Ensure keys permission are correct.
  ansible.builtin.file:
    path: /etc/openvpn/server/{{ item | basename }}
    mode: "0600"
  loop:
    - ca.crt
    - dh.pem
    - ta.key
    - issued/client.crt
    - issued/server.crt
    - private/ca.key
    - private/client.key
    - private/server.key

# Manipulate the server.conf file set by the OpenVPN role in Galaxy
- name: Prevent pushing DNS servers.
  ansible.builtin.lineinfile:
    path: "{{ openvpn_configuration_directory }}/server.conf"
    search_string: "dhcp-option DNS"
    state: absent

- name: Remove remote-cert-eku assumption.
  ansible.builtin.lineinfile:
    path: "{{ openvpn_configuration_directory }}/server.conf"
    search_string: "remote-cert-eku"
    state: absent

- name: Make forced redirect optional.
  ansible.builtin.lineinfile:
    path: "{{ openvpn_configuration_directory }}/server.conf"
    search_string: "redirect-gateway def1 bypass-dhcp"
    state: absent
  when: not openvpn_ldap.force_redirect_gateway

- name: Enable VPN compression.
  ansible.builtin.lineinfile:
    path: "{{ openvpn_configuration_directory }}/server.conf"
    line: comp-lzo
    create: true
  when: openvpn_ldap.compress

- name: Enable LDAP config.
  ansible.builtin.lineinfile:
    path: "{{ openvpn_configuration_directory }}/server.conf"
    line: "plugin /usr/lib/openvpn/openvpn-auth-ldap.so {{ openvpn_configuration_directory }}/auth/auth-ldap.conf"
    create: true

- name: Set no client cert required.
  ansible.builtin.lineinfile:
    path: "{{ openvpn_configuration_directory }}/server.conf"
    line: client-cert-not-required
    create: true
  when: openvpn_ldap.no_client_cert

- name: Create custom directives.
  ansible.builtin.lineinfile:
    path: "{{ openvpn_configuration_directory }}/server.conf"
    line: "{{ item }}"
    create: true
  loop: "{{ openvpn_ldap.custom_directives }}"
  when: openvpn_ldap.custom_directives

- name: Restart OpenVPN.
  ansible.builtin.systemd:
    name: "{{ openvpn_service }}"
    state: restarted
    daemon_reload: true
