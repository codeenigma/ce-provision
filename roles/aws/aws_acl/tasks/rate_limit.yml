---
- name: Set rate based statement from template
  ansible.builtin.set_fact:
    _rbs: "{{ lookup('ansible.builtin.template', './rate_limit.j2') | from_yaml }}"

- name: Set action statement
  ansible.builtin.set_fact:
    _action: "{ {{ _acl.rules.rate_limit.action | default('block') }}: {} }"

- name: Define rate rule.
  ansible.builtin.set_fact:
    rate_rule:
      name: "{{ _acl.rules.rate_limit.name | default('rate_limit') }}"
      action: "{{ _action | from_yaml }}"
      visibility_config:
        sampled_requests_enabled: true
        cloud_watch_metrics_enabled: true
        metric_name: "{{ _acl.rules.rate_limit.name | default('rate_limit') }}"
      Statement:
        rate_based_statement: "{{ _rbs }}"

- name: Set priority.
  ansible.builtin.include_tasks: set_priority_dict.yml
  vars:
    _priority: "{{ _acl.rules.rate_limit.priority }}"

- name: Append priority to rule.
  ansible.builtin.set_fact:
    rate_rule: "{{ rate_rule | combine(_priority_dict) }}"

- name: Add rule to list.
  ansible.builtin.set_fact:
    _rules: "{{ _rules + [rate_rule] }}"
