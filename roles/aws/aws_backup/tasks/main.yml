---
- name: Check if the backup vault already exists.
  ansible.builtin.command: >
    aws backup list-backup-vaults --query "BackupVaultList[?BackupVaultName=='{{ aws_backup.vault.name }}'].BackupVaultName" --output text
  register: _vault_exists

- name: Check if the off-site backup vault already exists.
  ansible.builtin.command: >
    aws backup list-backup-vaults --query "BackupVaultList[?BackupVaultName=='{{ aws_backup.copy_vault.name }}'].BackupVaultName" --output text
  register: _copy_vault_exists
  when:
    - aws_backup.copy_vault.region is defined
    - aws_backup.copy_vault.region | length > 0

- name: Create backup vault without user-provided KMS key.
  ansible.builtin.command: >
    aws backup create-backup-vault --backup-vault-name {{ aws_backup.vault.name }}
  register: _vault_created
  when:
    - aws_backup.vault.encryption_key == "Default"
    - _vault_exists.stdout | length == 0

- name: Create backup vault with user-provided KMS key.
  ansible.builtin.command: >
    aws backup create-backup-vault --backup-vault-name {{ aws_backup.vault.name }} --encryption-key {{ aws_backup.vault.encryption_key }}
  register: _vault_created
  when:
    - aws_backup.vault.encryption_key != "Default"
    - _vault_exists.stdout | length == 0

- name: Create off-site backup vault without user-provided KMS key.
  ansible.builtin.command: >
    aws backup create-backup-vault --backup-vault-name {{ aws_backup.copy_vault.name }} --region {{ aws_backup.copy_vault.region }}
  register: _copy_vault_created
  when:
    - aws_backup.copy_vault.region is defined
    - aws_backup.copy_vault.region | length > 0
    - aws_backup.copy_vault.encryption_key == "Default"
    - _copy_vault_exists.stdout | length == 0

- name: Create off-site backup vault with user-provided KMS key.
  ansible.builtin.command: >
    aws backup create-backup-vault --backup-vault-name {{ aws_backup.copy_vault.name }} --encryption-key {{ aws_backup.copy_vault.encryption_key }} --region {{ aws_backup.copy_vault.region }}
  register: _copy_vault_created
  when:
    - aws_backup.copy_vault.region is defined
    - aws_backup.copy_vault.region | length > 0
    - aws_backup.copy_vault.encryption_key != "Default"
    - _copy_vault_exists.stdout | length == 0

- name: Create empty dictionary for backup plan info.
  ansible.builtin.set_fact:
    backup_plan_info: {}

- name: Create backup plans.
  include_tasks: backup_plan.yml
  with_items: "{{ aws_backup.plans }}"
  loop_control:
    loop_var: plan
  when: aws_backup.plans | length