---
- name: Gather AWS account ID.
  amazon.aws.aws_caller_info:
    profile: "{{ _aws_profile }}"
  delegate_to: localhost
  register: _aws_account_info_backup

- name: Create SNS topic for Backup notifications.
  include_role:
    name: aws/aws_sns
  vars:
    aws_sns:
      aws_profile: "{{ _aws_profile }}"
      region: "{{ _aws_region }}"
      name: "{{ aws_backup.sns.name }}"
      display_name: "{{ aws_backup.sns.display_name }}"
      policy: |
        {
          "Version": "2008-10-17",
          "Id": "__default_policy_ID",
          "Statement": [
            {
              "Sid": "__default_statement_ID",
              "Effect": "Allow",
              "Principal": {
                "AWS": "*"
              },
              "Action": [
                "SNS:Publish",
                "SNS:RemovePermission",
                "SNS:SetTopicAttributes",
                "SNS:DeleteTopic",
                "SNS:ListSubscriptionsByTopic",
                "SNS:GetTopicAttributes",
                "SNS:Receive",
                "SNS:AddPermission",
                "SNS:Subscribe"
              ],
              "Resource": "arn:aws:sns:region:{{ _aws_account_info_backup.account }}:{{ aws_backup.sns.name }}",
              "Condition": {
                "StringEquals": {
                  "AWS:SourceOwner": "{{ _aws_account_info_backup.account }}"
                }
              }
            },
            {
              "Sid": "__console_pub_0",
              "Effect": "Allow",
              "Principal": {
                "Service": "backup.amazonaws.com"
              },
              "Action": "SNS:Publish",
              "Resource": "arn:aws:sns:region:{{ _aws_account_info_backup.account }}:{{ aws_backup.sns.name }}"
            }
          ]
        }
      delivery_policy_default_healthy_retry_policy_min_delay_target: "{{ aws_backup.sns.delivery_policy_default_healthy_retry_policy_min_delay_target }}"
      delivery_policy_default_healthy_retry_policy_max_delay_target: "{{ aws_backup.sns.delivery_policy_default_healthy_retry_policy_max_delay_target }}"
      delivery_policy_default_healthy_retry_policy_num_retries: "{{ aws_backup.sns.delivery_policy_default_healthy_retry_policy_num_retries }}"
      delivery_policy_default_healthy_retry_policy_num_max_delay_retries: "{{ aws_backup.sns.delivery_policy_default_healthy_retry_policy_num_max_delay_retries }}"
      delivery_policy_default_healthy_retry_policy_num_no_delay_retries: "{{ aws_backup.sns.delivery_policy_default_healthy_retry_policy_num_no_delay_retries }}"
      delivery_policy_default_healthy_retry_policy_num_min_delay_retries: "{{ aws_backup.sns.delivery_policy_default_healthy_retry_policy_num_min_delay_retries }}"
      delivery_policy_default_healthy_retry_policy_backoff_function: "{{ aws_backup.sns.delivery_policy_default_healthy_retry_policy_backoff_function }}"
      delivery_policy_disable_subscription_overrides: "{{ aws_backup.sns.delivery_policy_disable_subscription_overrides }}"
  when:
    - aws_backup.sns.sns is defined
    - aws_backup.sns.sns

- name: Create SNS subscriptions for failed Backup jobs.
  include_tasks:
    file: subscribe.yml
  with_items: "{{ aws_backup.sns.subscriptions }}"
  loop_control:
    loop_var: sub_var
  when:
    - aws_backup.sns.sns is defined
    - aws_backup.sns.sns
    - aws_backup.sns.subscriptions | length > 0

- name: Check if the backup vault already exists.
  ansible.builtin.command: >
    aws backup list-backup-vaults --query "BackupVaultList[?BackupVaultName=='{{ aws_backup.vault.name }}'] | [0]" --output json
  register: _vault_exists

- name: Check if the off-site backup vault already exists.
  ansible.builtin.command: >
    aws backup list-backup-vaults --region {{ aws_backup.copy_vault.region }} --query "BackupVaultList[?BackupVaultName=='{{ aws_backup.copy_vault.name }}'] | [0]" --output json
  register: _copy_vault_exists
  when:
    - aws_backup.copy_vault.region is defined
    - aws_backup.copy_vault.region | length > 0

- name: Create backup vault without user-provided KMS key.
  ansible.builtin.command: >
    aws backup create-backup-vault --backup-vault-name {{ aws_backup.vault.name }}
  register: _vault_created
  when:
    - aws_backup.vault.encryption_key == "Default"
    - _vault_exists.stdout == "null"

- name: Create backup vault with user-provided KMS key.
  ansible.builtin.command: >
    aws backup create-backup-vault --backup-vault-name {{ aws_backup.vault.name }} --encryption-key {{ aws_backup.vault.encryption_key }}
  register: _vault_created
  when:
    - aws_backup.vault.encryption_key != "Default"
    - _vault_exists.stdout == "null"

- name: Enable notifications for failed backup jobs.
  ansible.builtin.command: >
    aws backup put-backup-vault-notifications --endpoint-url https://backup.{{ _aws_region }}.amazonaws.com --backup-vault-name {{ aws_backup.vault.name }} --sns-topic-arn {{ _aws_sns_topic_info.sns_arn }} --backup-vault-events BACKUP_JOB_COMPLETED
  when:
    - aws_backup.sns.sns is defined
    - aws_backup.sns.sns

- name: Create off-site backup vault without user-provided KMS key.
  ansible.builtin.command: >
    aws backup create-backup-vault --backup-vault-name {{ aws_backup.copy_vault.name }} --region {{ aws_backup.copy_vault.region }}
  register: _copy_vault_created
  when:
    - aws_backup.copy_vault.region is defined
    - aws_backup.copy_vault.region | length > 0
    - aws_backup.copy_vault.encryption_key == "Default"
    - _copy_vault_exists.stdout == "null"

- name: Create off-site backup vault with user-provided KMS key.
  ansible.builtin.command: >
    aws backup create-backup-vault --backup-vault-name {{ aws_backup.copy_vault.name }} --encryption-key {{ aws_backup.copy_vault.encryption_key }} --region {{ aws_backup.copy_vault.region }}
  register: _copy_vault_created
  when:
    - aws_backup.copy_vault.region is defined
    - aws_backup.copy_vault.region | length > 0
    - aws_backup.copy_vault.encryption_key != "Default"
    - _copy_vault_exists.stdout == "null"

- name: Gather off-site backup vault info.
  ansible.builtin.command: >
    aws backup list-backup-vaults --region {{ aws_backup.copy_vault.region }} --query "BackupVaultList[?BackupVaultName=='{{ aws_backup.copy_vault.name }}'] | [0]" --output json
  register: _copy_vault_info
  when: _copy_vault_created is defined

- name: Create backup plans.
  include_tasks: backup_plan.yml
  with_items: "{{ aws_backup.plans }}"
  loop_control:
    loop_var: plan
  when: aws_backup.plans | length