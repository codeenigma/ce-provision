---
- name: Build extra variables string to pass to Ansible.
  ansible.builtin.set_fact:
    _aws_ami_extra_vars: "{{ ('' if not ansible_loop.first else '{ ') + _aws_ami_extra_vars | default('') + item + (', ' if not ansible_loop.last else ' }') }}"
  with_items: "{{ aws_ami.extra_vars }}"
  loop_control:
    extended: true
  when: aws_ami.extra_vars | length > 0

- name: Generate Packer template.
  ansible.builtin.template:
    src: packer.json.j2
    dest: "{{ _ce_provision_build_tmp_dir }}/packer.json"
    mode: "0666"

- name: Inspect Packer configuration.
  ansible.builtin.command:
    cmd: "packer inspect {{ _ce_provision_build_tmp_dir }}/packer.json"
    chdir: "{{ _ce_provision_base_dir }}"

- name: Build Packer command.
  ansible.builtin.set_fact:
    _aws_ami_packer_command: "-on-error={{ aws_ami.on_error }} {{ _ce_provision_build_tmp_dir }}/packer.json"

- name: Add -force option to Packer command.
  ansible.builtin.set_fact:
    _aws_ami_packer_command: "-force {{ _aws_ami_packer_command }}"
  when: aws_ami.force

  - name: Add -debug option to Packer command.
  ansible.builtin.set_fact:
    _aws_ami_packer_command: "-debug {{ _aws_ami_packer_command }}"
  when: aws_ami.debug

- name: Build AMI.
  ansible.builtin.command:
    cmd: "packer build {{ _aws_ami_packer_command }}"
    chdir: "{{ _ce_provision_base_dir }}"
