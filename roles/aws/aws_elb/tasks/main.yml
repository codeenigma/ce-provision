---

- name: Gather VPC information.
  amazon.aws.ec2_vpc_net_info:
    profile: "{{ aws_elb.aws_profile }}"
    region: "{{ aws_elb.region }}"
    filters:
      "tag:Name": "{{ aws_elb.vpc_name }}"
  register: _aws_ec2_elb_vpc
  when: ( aws_elb.vpc_name is defined and aws_elb.vpc_name | length > 0 )

- name: Set the VPC id from name.
  ansible.builtin.set_fact:
    _aws_ec2_elb_vpc_id: "{{ _aws_ec2_elb_vpc.vpcs[0].vpc_id }}"
  when: ( aws_elb.vpc_name is defined and aws_elb.vpc_name | length > 0 )

- name: Use provided VPC id.
  ansible.builtin.set_fact:
    _aws_ec2_elb_vpc_id: "{{ aws_elb.vpc_id }}"
  when: ( aws_elb.vpc_name is not defined or aws_elb.vpc_name | length < 0 )

- name: Reset subnets lists.
  ansible.builtin.set_fact:
    _aws_ec2_elb_public_subnets_ids: []

- name: Construct list of public subnet IDs.
  ansible.builtin.include_tasks: subnet.yml
  with_items: "{{ aws_elb.subnets }}"
  loop_control:
    loop_var: subnet

- name: Set a default target group list.
  ansible.builtin.set_fact:
    _targets: []

- name: Construct list of instance IDs for ELB target group.
  ansible.builtin.include_tasks: "target_group.yml"
  with_items: "{{ aws_elb.targets }}"
  loop_control:
    loop_var: tg_instance
  when:
    - aws_elb.targets is defined
    - aws_elb.targets | length > 0

- name: Create a Target group for port 80.
  community.aws.elb_target_group:
    profile: "{{ aws_elb.aws_profile }}"
    name: "{{ aws_elb.name }}"
    state: "{{ aws_elb.state }}"
    region: "{{ aws_elb.region }}"
    tags: "{{ aws_elb.tags }}"
    protocol: http
    port: 80
    vpc_id: "{{ _aws_ec2_elb_vpc_id }}"
    deregistration_delay_timeout: "{{ aws_elb.deregistration_delay_timeout }}"
    health_check_protocol: "{{ aws_elb.health_check_protocol }}"
    health_check_path: "{{ aws_elb.health_check_path }}"
    health_check_port: "{{ aws_elb.health_check_port }}"
    successful_response_codes: "{{ aws_elb.health_check_success_codes }}"
    health_check_interval: "{{ aws_elb.health_check_interval }}"
    health_check_timeout: "{{ aws_elb.health_check_timeout }}"
    healthy_threshold_count: "{{ aws_elb.health_check_healthy_count }}"
    unhealthy_threshold_count: "{{ aws_elb.health_check_unhealthy_count }}"
    modify_targets: false
    targets: "{{ _targets }}"
  register: _aws_ec2_elb_target_group_created

- name: Create SSL certificate.
  ansible.builtin.include_role:
    name: aws/aws_acm
  vars:
    aws_acm:
      export: false
      domain_name: "{{ aws_elb.route_53.record }}" # use the same value as we create the DNS record with later
      extra_domains: "{{ aws_elb.acm.extra_domains }}"
      route_53:
        aws_profile: "{{ aws_elb.acm.route_53.aws_profile }}"
        zone: "{{ aws_elb.acm.route_53.zone }}"
  when: aws_elb.acm.create_cert

- name: Default to provided SSL certificate ARN.
  ansible.builtin.set_fact:
    _ssl_certificate_ARN: "{{ aws_elb.ssl_certificate_ARN }}"

- name: If provided, override SSL certificate ARN with the one received from ACM.
  ansible.builtin.set_fact:
    _ssl_certificate_ARN: "{{ aws_acm_certificate_arn }}"
  when: aws_elb.acm.create_cert

- name: Define default ALB listeners.
  ansible.builtin.set_fact:
    _aws_ec2_listeners_http:
      Protocol: HTTP
      Port: "80"
      DefaultActions:
        - Type: forward
          TargetGroupName: "{{ aws_elb.target_group_name }}"
    _aws_ec2_listeners_redirect:
      Protocol: HTTP
      Port: "80"
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Host: "#{host}"
            Query: "#{query}"
            Path: "/#{path}"
            Port: "443"
            StatusCode: HTTP_301
    _aws_ec2_listeners_https:
      Protocol: HTTPS
      Port: "443"
      SslPolicy: "{{ aws_elb.alb_ssl_policy }}"
      Certificates:
        - CertificateArn: "{{ _ssl_certificate_ARN }}"
      DefaultActions:
        - Type: forward
          TargetGroupName: "{{ aws_elb.target_group_name }}"

- name: Add HTTP listeners.
  ansible.builtin.set_fact:
    _aws_ec2_listeners: "{{ [ _aws_ec2_listeners_http ] }}"
  when: _ssl_certificate_ARN | length < 1

- name: Add HTTPS Listener.
  ansible.builtin.set_fact:
    _aws_ec2_listeners: "{{ [ _aws_ec2_listeners_redirect, _aws_ec2_listeners_https ] }}"
  when: _ssl_certificate_ARN | length > 1

- name: Add custom Listeners.
  ansible.builtin.set_fact:
    _aws_ec2_listeners: "{{ _aws_ec2_listeners + aws_elb.listeners }}"
  when:
    - aws_elb is defined
    - aws_elb | length

- name: Create the ALB.
  community.aws.elb_application_lb:
    name: "{{ aws_elb.name }}"
    profile: "{{ aws_elb.aws_profile }}"
    region: "{{ aws_elb.region }}"
    state: "{{ aws_elb.state }}"
    tags: "{{ aws_elb.tags }}"
    subnets: "{{ _aws_ec2_elb_public_subnets_ids }}"
    security_groups: "{{ aws_elb.security_groups }}"
    listeners: "{{ _aws_ec2_listeners }}"
    idle_timeout: "{{ aws_elb.idle_timeout }}"
  register: _aws_ec2_elb
  when: aws_elb.elb_type == "alb"

- name: Get ALB listener ARN for port 443.
  ansible.builtin.set_fact:
    _aws_ec2_elb_listener_ARN: "{{ item.listener_arn }}"
  when:
    - "{{ item.port == 443 }}"
    - aws_elb.ssl_extra_certificate_ARNs
    - _ssl_certificate_ARN | length > 1
  with_items: "{{ _aws_ec2_elb.listeners }}"

- name: Add extra SSL certificates to the ALB.
  ansible.builtin.command:
    cmd: "aws elbv2 add-listener-certificates --region {{ aws_elb.region }} --profile {{ aws_elb.aws_profile }} --listener-arn {{ _aws_ec2_elb_listener_ARN }} --certificates CertificateArn={{ item }}"
  when:
    - aws_elb.ssl_extra_certificate_ARNs
    - _ssl_certificate_ARN | length > 1
  with_items: "{{ aws_elb.ssl_extra_certificate_ARNs }}"
