---
- name: Create the deploy group.
  ansible.builtin.group:
    name: "{{ ce_deploy.username }}"
    system: true
  when: ce_deploy.new_user

- name: Create the deploy user for deployments.
  ansible.builtin.user:
    name: "{{ ce_deploy.username }}"
    comment: Continuous Deployment
    shell: /bin/bash
    group: "{{ ce_deploy.username }}"
    uid: "{{ ce_deploy.uid | default(omit) }}"
    create_home: true
    generate_ssh_key: true
    home: "/home/{{ ce_deploy.username }}"
    password: "*"
    ssh_key_bits: 4096
    ssh_key_comment: "{{ ce_deploy.username }}@{{ ansible_host }}"
    system: true
    groups: "{{ ce_deploy.groups }}"
  when: ce_deploy.new_user
# @see https://github.com/ansible/ansible/issues/24862
- name: Ensure home ownership.
  ansible.builtin.file:
    path: "/home/{{ ce_deploy.username }}"
    state: directory
    owner: "{{ ce_deploy.username }}"
    group: "{{ ce_deploy.username }}"
    recurse: true
  when: ce_deploy.new_user

- name: Fetch back the SSH pub key.
  ansible.builtin.fetch:
    dest: "{{ _ce_provision_data_dir }}"
    src: "/home/{{ ce_deploy.username }}/.ssh/{{ ce_deploy.key_name }}"

- name: Ensure Git is installed.
  ansible.builtin.apt:
    pkg: "git"
    state: present

- name: Ensure deploy scripts are presents.
  ansible.builtin.git:
    repo: "{{ ce_deploy.own_repository | default('https://github.com/codeenigma/ce-deploy.git') }}"
    dest: "{{ ce_deploy.local_dir }}"
    version: "{{ ce_deploy.own_repository_branch  | default('master') }}"
    update: true
    # @todo?
    accept_hostkey: true
  become: true
  become_user: "{{ ce_deploy.username }}"

- name: Checkout config directory.
  ansible.builtin.git:
    repo: "{{ ce_deploy.config_repository }}"
    accept_hostkey: true
    dest: "{{ _ce_provision_build_tmp_dir }}/config"
    version: "{{ ce_deploy.config_repository_branch  | default('master') }}"
  become: false
  delegate_to: localhost
  when: ce_deploy.config_repository is defined and ce_deploy.config_repository

- name: Synchronize config directory.
  synchronize:
    src: "{{ _ce_provision_build_tmp_dir }}/config"
    dest: "{{ ce_deploy.local_dir }}/"
    delete: true
    rsync_opts:
      - "--chown={{ ce_deploy.username }}:{{ ce_deploy.username }}"
  when: ce_deploy.config_repository is defined and ce_deploy.config_repository

- name: Check if we have a config directory.
  ansible.builtin.stat:
    path: "{{ ce_deploy.local_dir }}/config"
  register: ce_deploy_config_repo

- name: Register config repository.
  ansible.builtin.set_fact:
    key_value: ce_deploy_has_config_repo
    ce_deploy_has_config_repo: "{{ 'yes' if ce_deploy_config_repo.stat.isdir is defined and ce_deploy_config_repo.stat.isdir else 'no' }}"

- name: Create defaults folders.
  ansible.builtin.file:
    path: "{{ ce_deploy.local_dir }}/{{ item }}"
    state: directory
  with_items:
    - hosts
  when: not ce_deploy_has_config_repo

- name: Create default config.
  ansible.builtin.copy:
    src: ansible.cfg
    dest: "{{ ce_deploy.local_dir }}/ansible.cfg"
  when: not ce_deploy_has_config_repo

- name: Remove defaults folders.
  ansible.builtin.file:
    path: "{{ ce_deploy.local_dir }}/{{ item }}"
    state: absent
  with_items:
    - hosts
    - ansible.cfg
  when: ce_deploy_has_config_repo

- name: Symlink config folders to /etc/ansible.
  ansible.builtin.file:
    dest: "{{ ce_deploy.local_dir }}/{{ item }}"
    src: "{{ ce_deploy.local_dir }}/config/{{ item }}"
    state: link
  with_items:
    - hosts
    - ansible.cfg
  when: ce_deploy_has_config_repo

- name: Create data dir.
  ansible.builtin.file:
    path: "{{ ce_deploy.local_dir }}/data"
    state: directory

- name: Ensure ownership of Ansible folder.
  ansible.builtin.file:
    path: "{{ ce_deploy.local_dir }}"
    state: directory
    owner: "{{ ce_deploy.username }}"
    recurse: true

# - name: Gather AWS account ID if it isn't already set.
#   amazon.aws.aws_caller_info:
#     profile: "{{ _aws_profile }}"
#   delegate_to: localhost
#   become: true
#   become_user: "{{ _ce_provision.username }}"
#   register: _deploy_caller_info

# - name: Create IAM policy for deploy user
#   community.aws.iam_policy:
#     iam_type: user
#     iam_name: "{{ ce_deploy.username }}"
#     policy_name: "{{ ce_deploy.asg_processes_policy_name }}"
#     policy_json: "{{ lookup('template', 'asg_processes.json.j2') }}"
#     state: present
#   delegate_to: localhost

- name: Check if ansible-galaxy custom requirements file exists.
  ansible.builtin.stat:
    path: "{{ ce_deploy.galaxy_custom_requirements_file }}"
  register: _ce_deploy_custom_galaxy_requirements

- name: Copy mandatory ansible-galaxy requirements file to deploy server.
  ansible.builtin.copy:
    src: "{{ ce_deploy.ce_provision_dir }}/roles/ce_deploy/meta/requirements.yml"
    dest: "{{ ce_deploy.local_dir }}/requirements.yml"
    owner: "{{ ce_deploy.username }}"
    group: "{{ ce_deploy.username }}"
    mode: '0644'

- name: Install mandatory ansible-galaxy roles and collections.
  ansible.builtin.command:
    cmd: "ansible-galaxy install -r {{ ce_deploy.local_dir }}/requirements.yml"
  become: true
  become_user: "{{ ce_deploy.username }}"

- name: Clean up mandatory ansible-galaxy requirements file.
  ansible.builtin.file:
    path: "{{ ce_deploy.local_dir }}/requirements.yml"
    state: absent

- name: Install custom ansible-galaxy roles and collections.
  ansible.builtin.command:
    cmd: "ansible-galaxy install -r {{ ce_deploy.galaxy_custom_requirements_file }}"
  become: true
  become_user: "{{ ce_deploy.username }}"
  when: _ce_deploy_custom_galaxy_requirements.stat.exists
