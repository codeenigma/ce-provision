---
- set_fact:
    _ldap_server_bind_pwd: "{{ ldap_server.replication.bind_pwd | default(lookup('password', '/dev/null'), true) }}"

- set_fact:
    _ldap_server_bind_pwd_hash: "{{ '{{ _ldap_server_bind_pwd }}' | password_hash('sha512') }}"

- name: Create bind user on host.
  community.general.ldap_entry:
    dn: "{{ ldap_server.replication.bind_dn }}"
    objectClass:
      - simpleSecurityObject
      - organizationalRole
    attributes:
      description: "Replication user for {{ _domain_name }}"
      userPassword: "{CRYPT}{{ _ldap_server_bind_pwd_hash }}"
    bind_dn: "{{ ldap_server.replication.admin_dn }}"
    bind_pw: "{{ ldap_server.replication.admin_pwd }}"
  delegate_to: "{{ ldap_server.replication.host }}"

- name: Set replication config.
  community.general.ldap_attrs:
    dn: olcDatabase={1}hdb,cn=config
    attributes:
        olcSyncrepl:
          - >-
            rid=123
            provider="ldaps://{{ ldap_server.replication.host }}:{{ ldap_server.replication.port }}/"
            tls_reqcert=never
            type=refreshOnly
            interval={{ ldap_server.replication.interval }}
            searchbase="{{ ldap_server.replication.searchbase }}"
            bindmethod=simple
            binddn="{{ ldap_server.replication.bind_dn }}"
            credentials="{{ _ldap_server_bind_pwd }}"

- name: Stop slapd service.
  ansible.builtin.service:
    name: slapd
    state: stopped

# This is defending against a specific bug with Docker and the init script - https://stackoverflow.com/questions/30671693
# @TODO: refactor this to be a role based on this - https://stackoverflow.com/a/69017642/896690
- name: Ensure running slapd processes are killed.
  ansible.builtin.command:
    cmd: pkill slapd
  ignore_errors: true

- name: Delete existing LDAP data before restarting replication.
  ansible.builtin.file:
    path: /var/lib/ldap
    state: absent

- name: Recreate LDAP data directory.
  ansible.builtin.file:
    path: /var/lib/ldap
    state: directory
    owner: openldap
    group: openldap
    mode: 0755

- name: Start slapd service.
  ansible.builtin.service:
    name: slapd
    state: started
