---
- name: Ensure apache is installed.
  ansible.builtin.apt:
    name: apache2
    state: present
    update_cache: true
    cache_valid_time: 240

- name: Ensure apache utils are installed.
  ansible.builtin.apt:
    name: apache2-utils
    state: present
    update_cache: true
    cache_valid_time: 240

- name: Copy main apache config.
  template:
    src: apache2.conf.j2
    dest: "/etc/apache2/apache2.conf"
    owner: root
    group: root
    mode: 0644

- name: Ensure passwords directory exists.
  file:
    path: /etc/apache2/passwords
    state: directory
    mode: "0755"

- name: Ensure log dir exists.
  file:
    path: "/var/log/apache2"
    state: directory

- name: Remove existing vhosts
  file:
    path: "/etc/apache2/sites-enabled"
    state: absent

- name: Recreate vhosts folder
  file:
    path: "/etc/apache2/sites-enabled"
    state: directory

- name: Check if we have an AWS Cloudwatch folder.
  ansible.builtin.stat:
    path: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.d
  register: _apache2_cloudwatch_dir

- name: Generates AWS Cloudwatch default config.
  template:
    src: cloudwatch-main.json.j2
    dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.d/apache2-main.json
  when:
    - _apache2_cloudwatch_dir.stat.isdir is defined and _apache2_cloudwatch_dir.stat.isdir

- name: Generate domain specific configuration.
  include_tasks: domain.yml
  with_items: "{{ apache.domains }}"
  loop_control:
    loop_var: domain

- name: Enable Apache mods.
  file:
    src: "/etc/apache2/mods-available/{{ item }}"
    dest: "/etc/apache2/mods-enabled/{{ item }}"
    state: link
    mode: 0644
  with_items: "{{ apache.mods_enabled }}"

- name: Ensure apache2 is restarted.
  service:
    name: apache2
    state: restarted
